function decodeJWT(token) {
  try {
    const base64Payload = token.split(".")[1];
    const jsonPayload = atob(base64Payload);
    return JSON.parse(jsonPayload);
  } catch {
    return null;
  }
}

async function verifierToken() {
  // üö´ √âvite une boucle : si on est d√©j√† sur unauthorized.html, on ne v√©rifie rien
  if (window.location.pathname.endsWith("unauthorized.html")) {
    return;
  }

  const params = new URLSearchParams(window.location.search);
  const urlToken = params.get("token");
  const storedToken = localStorage.getItem("jwtToken");

  // Si un token √©tait d√©j√† pr√©sent et qu'un autre est fourni dans l'URL,
  // on consid√®re qu'il s'agit d'un lien obsol√®te
  if (urlToken && storedToken && urlToken !== storedToken) {
    console.warn("‚ùå Ancien token d√©tect√©. Acc√®s refus√©.");
    window.location.href = "unauthorized.html";
    return;
  }

  // Si un token est pr√©sent dans l'URL, il devient le nouveau token stock√©
  if (urlToken) {
    localStorage.setItem("jwtToken", urlToken);
  }

  const token = localStorage.getItem("jwtToken");

  if (!token) {
    console.warn("‚ùå Aucun token trouv√© dans l'URL ou le stockage.");
    window.location.href = "unauthorized.html";
    return;
  }

  const decoded = decodeJWT(token);
  if (!decoded) {
    console.warn("‚ùå Token illisible.");
    window.location.href = "unauthorized.html";
    return;
  }

  if (typeof decoded.exp === "number" && decoded.exp * 1000 < Date.now()) {
    console.warn("‚ùå Token expir√©.");
    window.location.href = "unauthorized.html";
    return;
  }

  try {
    const resp = await fetch(`/validate?token=${encodeURIComponent(token)}`);
    const json = await resp.json();
    if (!json.ok) {
      console.warn("‚ùå Token refus√© :", json.reason);
      window.location.href = "unauthorized.html";
      return;
    }
  } catch (err) {
    console.warn("‚ùå Erreur de validation du token:", err);
    window.location.href = "unauthorized.html";
    return;
  }

  console.log("‚úÖ Token d√©tect√© et valid√© :", decoded);
}

// ‚ñ∂Ô∏è Lancer la v√©rification au chargement
verifierToken();
